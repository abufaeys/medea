<!DOCTYPE html>
<html>
<head>
    <title>Chat</title>
    <meta http-equiv='Content-Type' content='text/html; charset=UTF-8'/>

    <script type="text/javascript">

        var socket;
        var pcs = {};
        var transceivers = [];

        function connectSocket(caller) {
            let role = caller ? "caller/test" : "responder/test";
            socket = new WebSocket("ws://localhost:8080/ws/pub-sub-video-call/" + role);
            socket.onmessage = handleSocketMessage;

            window.setInterval(function () {
                socket.send("{\"ping\":1}");
            }, 8000);
        };

        function handleSocketMessage(message) {
            var msg = JSON.parse(message.data);
            switch (msg.event) {
                case 'PeerCreated':
                    handlePeerCreated(msg.data);
                    break;
                case 'SdpAnswerMade':
                    handleSdpAnswerMade(msg.data);
                    break;
                case 'IceCandidateDiscovered':
                    handleIceCandidateDiscovered(msg.data);
                    break;
            }
        }

        function get_mids() {
            var mids = {};
            console.log(transceivers);
            transceivers.forEach(function (v, i) {
                if (v != undefined) {
                    mids[i] = v.mid;
                }
            });

            return mids;
        }

        async function handlePeerCreated(msg) {
            var configuration = { iceServers: msg.ice_servers };
            pcs[msg.peer_id] = new RTCPeerConnection(configuration);
            pcs[msg.peer_id] = new RTCPeerConnection();

            var pc = pcs[msg.peer_id];

            var sendAudio = false;
            var sendVideo = false;

            msg.tracks.forEach((track) => {
                var transceiver;
                if (track.direction.Send != undefined) {
                    if (track.media_type.Audio != undefined) {
                        sendAudio = true;
                        transceiver = pc.addTransceiver("audio", {
                            direction: "sendonly"
                        })
                    } else {
                        sendVideo = true;
                        transceiver = pc.addTransceiver("video", {
                            direction: "sendonly"
                        })
                    }
                }

                transceivers[track.id] = transceiver;
            });

            pc.ontrack = function (e) {
                console.log(e);
                if (!partnervid.srcObject) {
                    partnervid.srcObject = e.streams[0];
                }
            };

            if (sendVideo || sendAudio) {
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: sendAudio,
                    video: sendVideo
                });

                yourvid.srcObject = stream;

                stream.getTracks().forEach((track) => {
                    if (track.kind == "audio"){
                        transceivers[1].sender.replaceTrack(track);
                    } else {
                        transceivers[2].sender.replaceTrack(track);
                    }
                });
            }

            if (msg.sdp_offer != undefined && msg.sdp_offer != null) {
                pc.setRemoteDescription(new RTCSessionDescription(JSON.parse(msg.sdp_offer)));
                var answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);

                socket.send(JSON.stringify({
                    command: "MakeSdpAnswer",
                    data: {
                        peer_id: msg.peer_id,
                        sdp_answer: JSON.stringify(answer),
                        mids: get_mids()
                    }
                }));
            } else {
                var offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                socket.send(JSON.stringify({
                    command: "MakeSdpOffer",
                    data: {
                        peer_id: msg.peer_id,
                        sdp_offer: JSON.stringify(offer),
                        mids: get_mids()
                    }
                }));
            }

            pc.onicecandidate = function (e) {
                if (e.candidate) {
                    socket.send(JSON.stringify({
                        command: "SetIceCandidate",
                        data: {
                            peer_id: msg.peer_id,
                            candidate: {
                                candidate: e.candidate.candidate,
                                sdp_mid: e.candidate.sdpMid,
                                sdp_m_line_index: e.candidate.sdpMLineIndex
                            }
                        }
                    }))
                }
            };
        }

        async function handleSdpAnswerMade(msg) {
            var pc = pcs[msg.peer_id];
            pc.setRemoteDescription(new RTCSessionDescription(JSON.parse(msg.sdp_answer)))
        }

        async function handleIceCandidateDiscovered(msg) {
            var pc = pcs[msg.peer_id];
            pc.addIceCandidate(            {
                candidate:msg.candidate.candidate,
                sdpMid:msg.candidate.sdp_mid,
                sdpMLineIndex: msg.candidate.sdp_m_line_index,
            });
        }

    </script>

    <style>
        .video-call {
            display: flex;
            flex-flow: row nowrap;
            width: 100%;
            flex-wrap: nowrap;
            flex-direction: row;
        }

        .video {
            display: flex;
            justify-content: center;
            flex-direction: column;
            margin-right: 10px;
            text-align: center;
        }

        .video > video {
            background: dimgrey;
        }

        .connect-btns {
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="video-call">
        <div class="video">
            <video id="yourvid" muted autoplay width="100%" height="100%"></video>
            <b>You</b>
        </div>
        <div class="video">
            <video id="partnervid" autoplay width="100%" height="100%"></video>
            <b>Partner</b>
        </div>
    </div>
    <div class="connect-btns">
        <button onclick="connectSocket(true)">Start caller session</button>
        <button onclick="connectSocket(false)">Start responder session</button>
    </div>
</body>
</html>
