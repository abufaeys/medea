<!DOCTYPE html>
<html>
<head>
    <title>Chat</title>
    <meta http-equiv='Content-Type' content='text/html; charset=UTF-8'/>

    <script type="text/javascript">

        var socket;
        var pcs = {};

        function connectSocket(caller) {
            let role = caller ? "1/caller_credentials" : "2/responder_credentials";
            socket = new WebSocket("ws://localhost:8080/ws/1/" + role);
            socket.onmessage = handleSocketMessage;

            window.setInterval(function () {
                socket.send("{\"ping\":1}");
            }, 8000);
        };

        function handleSocketMessage(message) {

            var msg = JSON.parse(message.data);

            if (msg.pong == undefined) {
                console.log(JSON.stringify(message.data));
                if (msg.PeerCreated != undefined) {
                    handlePeerCreated(msg.PeerCreated);
                }

                if (msg.SdpAnswerMade != undefined) {
                    handleSdpAnswerMade(msg.SdpAnswerMade);
                }

                if (msg.IceCandidateDiscovered != undefined) {
                    handleIceCandidateDiscovered(msg.IceCandidateDiscovered);
                }
            }
        }

        async function handlePeerCreated(msg) {
            var sendAudio = false;
            var sendVideo = false;
            var recvAudio = false;
            var recvVideo = false;

            msg.tracks.forEach((track) => {

                if (track.media_type.Audio != undefined) {
                if (track.direction.Send != undefined) {
                    sendAudio = true;
                }

                if (track.direction.Recv != undefined) {
                    recvAudio = true;
                }

            }
            if (track.media_type.Video != undefined) {
                if (track.direction.Send != undefined) {
                    sendVideo = true;
                }

                if (track.direction.Recv != undefined) {
                    recvVideo = true;
                }
            }
        });

            pcs[msg.peer_id] = new RTCPeerConnection();

            var pc = pcs[msg.peer_id];

            if (sendVideo || sendAudio) {
                let stream = await navigator.mediaDevices.getUserMedia({
                    audio: sendAudio,
                    video: sendVideo
                });

                yourvid.srcObject = stream;

                stream.getTracks().forEach((track) => {
                    pc.addTrack(track);
            });
            }


            var mediaConstraints = {
                'mandatory': {
                    'OfferToReceiveAudio': recvAudio,
                    'OfferToReceiveVideo': recvVideo
                }
            };

            if (msg.sdp_offer != undefined && msg.sdp_offer != null) {
                pc.setRemoteDescription(new RTCSessionDescription(JSON.parse(msg.sdp_offer)));
                var answer = await pc.createAnswer(mediaConstraints);
                pc.setLocalDescription(answer);

                socket.send(JSON.stringify({
                    MakeSdpAnswer: {
                        peer_id: msg.peer_id,
                        sdp_answer: JSON.stringify(answer)
                    }
                }));
            } else {
                var offer = await pc.createOffer(mediaConstraints);
                pc.setLocalDescription(offer);
                socket.send(JSON.stringify({
                    MakeSdpOffer: {
                        peer_id: msg.peer_id,
                        sdp_offer: JSON.stringify(offer)
                    }
                }));
            }


            pc.onicecandidate = function (e) {

                if (e.candidate) {
                    socket.send(JSON.stringify({
                        SetIceCandidate: {
                            peer_id: msg.peer_id,
                            candidate: JSON.stringify(e.candidate)
                        }
                    }))
                }

            };

            pc.ontrack = function (e) {
                partnervid.srcObject = e.streams[0];
            };


        }

        async function handleSdpAnswerMade(msg) {
            var pc = pcs[msg.peer_id];
            pc.setRemoteDescription(new RTCSessionDescription(JSON.parse(msg.sdp_answer)))
        }

        async function handleIceCandidateDiscovered(msg) {
            var pc = pcs[msg.peer_id];
            pc.addIceCandidate(JSON.parse(msg.candidate));
        }

    </script>
</head>
<body>
<div>
    <div>
        <div>
            <video id="yourvid" muted autoplay width="100%" height="100%"></video>
        </div>
        <div>
            <video id="partnervid" autoplay width="100%" height="100%"></video>
        </div>
    </div>
</div>
</body>
</html>
